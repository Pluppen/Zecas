---
import "@/styles/global.css";
import Layout from "@/layouts/Layout.astro";
import AuthWrapper from "@/layouts/AuthWrapper.astro";

import SeverityBadge from "@/components/findings/severity-badge";

const { finding } = Astro.params;
import { API_URL } from "@/config";

const findingData = await fetch(`${API_URL}/api/v1/findings/${finding}`).then(res => res.json())

const target = await fetch(`${API_URL}/api/v1/targets/${findingData.target_id}`).then(res => res.json())
---

<AuthWrapper>
    <Layout client:load breadcrumbL1="Findings" breadcrumbL2={findingData.title} breadcrumbL1Href="/project/findings/manage">
        <div class="container mx-auto mt-8">
            <SeverityBadge className={"px-2 mb-2 capitalize text-base"} severity={findingData.severity} />
            <h1 class="text-2xl mb-2">{findingData.title}</h1>
            <p>
                {findingData.description}
            </p>

            <hr class="my-4" />

            <p>Target: <span class="px-1 bg-muted rounded-sm">{target.value}</span></p>
            <p>Finding Type: <span class="px-1 bg-muted rounded-sm">{findingData.finding_type}</span></p>
            <p>Discovered At: <span class="px-1 bg-muted rounded-sm">{new Date(findingData.discovered_at).toLocaleString()}</span></p>

            { findingData.scan_id ? (
                <p class="mt-4">
                    <a class="underline hover:text-muted-foreground" href={`/scans/${findingData.scan_id}`}>Related scan</a>
                </p>
            ) : null}

            <h2 class="text-lg mt-2 mb-2">Raw Details</h2>
            <pre class="p-4 bg-muted text-wrap rounded-md">
                {JSON.stringify(findingData.details, null, 2)}
            </pre>
        </div>
    </Layout>
</AuthWrapper>